<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localizador GPS y Distancia</title>
    
    <!-- ENLACE A MANIFEST.JSON para modo standalone (PWA) -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Carga de Tailwind CSS para un dise帽o moderno y m贸vil-friendly -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados para la est茅tica */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fondo oscuro */
        }
        .card {
            background-color: #161b22; /* Fondo de tarjeta m谩s claro */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .result-label {
            color: #8b949e;
        }
        .result-value {
            color: #c9d1d9;
            word-break: break-all;
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

    <div id="app" class="card p-6 md:p-8 w-full max-w-sm mx-auto rounded-xl border border-gray-700">
        <h1 class="text-2xl font-bold text-white mb-4 text-center">Localizador GPS y Distancias</h1>
        <p class="text-sm text-gray-400 mb-6 text-center">Obt茅n tu posici贸n y calcula la distancia a puntos fijos.</p>

        <!-- Bot贸n de Acci贸n -->
        <button id="get-location-btn" 
                class="w-full py-3 px-4 mb-6 rounded-lg font-semibold transition duration-200 
                       bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/50 
                       focus:outline-none focus:ring-4 focus:ring-blue-500/50 active:scale-95">
            Obtener Coordenadas y Distancias
        </button>

        <!-- Indicador de Carga/Mensajes -->
        <div id="message" class="text-center text-sm mb-4 text-yellow-400 hidden">
            <!-- SVG de carga (Spinning loader) -->
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-400 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Buscando ubicaci贸n...
        </div>

        <!-- Alerta de Coincidencia (Nueva Secci贸n) -->
        <div id="match-alert" class="mt-6 p-4 bg-green-900/50 text-green-300 border border-green-700 rounded-xl text-center hidden">
            <div class="text-3xl mb-2"></div>
            <p class="font-bold text-lg">隆Coincidencia de Ubicaci贸n Encontrada!</p>
            <p id="matched-station-name" class="text-sm text-green-200 mt-1"></p>
        </div>


        <!-- Resultados de Ubicaci贸n Actual -->
        <div id="results-container" class="space-y-3 p-4 bg-gray-800 rounded-lg hidden">
            <h2 class="text-lg font-semibold text-green-400 mb-3 border-b border-gray-700 pb-2">Tu Ubicaci贸n Actual</h2>
            
            <div class="flex flex-col">
                <span class="result-label text-xs">Latitud:</span>
                <span id="latitude" class="result-value font-mono">--</span>
            </div>
            
            <div class="flex flex-col">
                <span class="result-label text-xs">Longitud:</span>
                <span id="longitude" class="result-value font-mono">--</span>
            </div>
        </div>
        
        <!-- RESULTADOS DE DISTANCIA A PUNTOS FIJOS -->
        <div id="distance-results-container" class="mt-6 p-4 bg-gray-800 rounded-lg hidden">
            <h2 class="text-lg font-semibold text-blue-400 mb-3 border-b border-gray-700 pb-2">Distancia a Puntos Fijos</h2>
            <div id="distance-list" class="space-y-2">
                <!-- Los resultados se inyectar谩n aqu铆 -->
            </div>
        </div>

        <!-- Contenedor para Errores -->
        <div id="error-box" class="p-3 mt-6 bg-red-800/30 text-red-400 rounded-lg hidden">
            <span class="font-bold">Error de GPS:</span> <span id="error-message"></span>
        </div>

        <!-- Sugerencia de instalaci贸n para m贸vil -->
        <div class="mt-6 p-3 text-center bg-gray-800/50 text-gray-400 text-xs rounded-lg border border-gray-700">
            <p>Modo PWA: se abre en ventana propia gracias al manifest.json.</p>
        </div>
    </div>

    <script>
        const btn = document.getElementById('get-location-btn');
        const message = document.getElementById('message');
        const resultsContainer = document.getElementById('results-container');
        const distanceContainer = document.getElementById('distance-results-container');
        const distanceList = document.getElementById('distance-list');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const matchAlert = document.getElementById('match-alert'); // NUEVO
        const matchedNameDisplay = document.getElementById('matched-station-name'); // NUEVO

        // Referencias a los campos de resultado de ubicaci贸n actual
        const latDisplay = document.getElementById('latitude');
        const lonDisplay = document.getElementById('longitude');
        
        // =======================================================
        // 1. COORDENADAS ALMACENADAS PARA LA COMPARACIN
        // Puedes cambiar estas coordenadas por las que necesites.
        // =======================================================
        const STATIONS = [
            { name: "Sede Central (Madrid)", lat: 40.4168, lon: -3.7038 }, // Madrid
            { name: "Punto de Reuni贸n (Barcelona)", lat: 41.3851, lon: 2.1734 }, // Barcelona
            { name: "Almac茅n Sur (Sevilla)", lat: 37.3891, lon: -5.9845 } // Sevilla
        ];

        // =======================================================
        // 2. FUNCIN DE CLCULO DE DISTANCIA (F贸rmula de Haversine)
        // =======================================================
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radio de la Tierra en kil贸metros
            const toRad = (degrees) => degrees * (Math.PI / 180);

            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);

            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distancia en km
        }

        /**
         * Funci贸n que se ejecuta cuando se obtiene la ubicaci贸n con 茅xito.
         * @param {GeolocationPosition} position - Objeto con los datos de la posici贸n.
         */
        function success(position) {
            // Detener la carga y ocultar errores
            message.classList.add('hidden');
            btn.disabled = false;
            btn.textContent = 'Obtener Coordenadas y Distancias';
            errorBox.classList.add('hidden');

            const currentLat = position.coords.latitude;
            const currentLon = position.coords.longitude;
            let matchFound = false;
            let matchedStationName = '';
            
            // 1. Mostrar ubicaci贸n actual
            latDisplay.textContent = currentLat.toFixed(6);
            lonDisplay.textContent = currentLon.toFixed(6);
            resultsContainer.classList.remove('hidden');

            // 2. Limpiar e inyectar resultados de distancia
            distanceList.innerHTML = '';
            
            STATIONS.forEach(station => {
                const distanceKm = calculateDistance(currentLat, currentLon, station.lat, station.lon);
                
                // --- LGICA DE COINCIDENCIA (NUEVO) ---
                // Si la distancia es menor a 50 metros (0.05 km), se considera una coincidencia.
                if (distanceKm < 50) { 
                    matchFound = true;
                    matchedStationName = station.name;
                }
                // -------------------------------------
                
                // Redondea a 2 decimales para mostrar
                const formattedDistance = distanceKm.toFixed(2); 

                // Crea el elemento de la lista
                const listItem = document.createElement('div');
                listItem.className = 'flex justify-between items-center py-2 border-b border-gray-700 last:border-b-0';
                listItem.innerHTML = `
                    <span class="text-gray-300 font-medium">${station.name}:</span>
                    <span class="text-lg font-bold ${matchFound && matchedStationName === station.name ? 'text-green-300' : 'text-blue-300'}">${formattedDistance} km</span>
                `;
                distanceList.appendChild(listItem);
            });

            // 3. Mostrar la alerta de coincidencia si se encuentra una
            if (matchFound) {
                matchedNameDisplay.textContent = `Est谩s muy cerca de: ${matchedStationName}`;
                matchAlert.classList.remove('hidden');
            } else {
                matchAlert.classList.add('hidden');
            }
            
            distanceContainer.classList.remove('hidden');

            // Opcional: Centrar la vista en el contenedor de resultados si est谩 en m贸vil
            distanceContainer.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Funci贸n que se ejecuta si hay un error al obtener la ubicaci贸n.
         * @param {GeolocationPositionError} err - Objeto de error.
         */
        function error(err) {
            // Detener la carga y mostrar el error
            message.classList.add('hidden');
            btn.disabled = false;
            btn.textContent = 'Obtener Coordenadas y Distancias';
            resultsContainer.classList.add('hidden');
            distanceContainer.classList.add('hidden');
            matchAlert.classList.add('hidden'); // Ocultar coincidencia en caso de error

            let msg = '';
            switch (err.code) {
                case err.PERMISSION_DENIED:
                    msg = "Permiso denegado: Necesitas permitir el acceso a la ubicaci贸n. Aseg煤rate de estar en un entorno HTTPS si no es localhost.";
                    break;
                case err.POSITION_UNAVAILABLE:
                    msg = "Posici贸n no disponible: No se puede determinar la ubicaci贸n.";
                    break;
                case err.TIMEOUT:
                    msg = "Tiempo de espera agotado: El intento de obtener la ubicaci贸n ha tardado demasiado.";
                    break;
                default:
                    msg = "Error desconocido (" + err.code + ").";
            }

            errorMessage.textContent = msg;
            errorBox.classList.remove('hidden');
            console.error('Error de Geolocation:', err.message);
        }

        /**
         * Funci贸n principal para solicitar la ubicaci贸n.
         */
        function getLocation() {
            if (!navigator.geolocation) {
                // Si el navegador no soporta Geolocation
                errorMessage.textContent = "Tu navegador no soporta la API de Geolocation.";
                errorBox.classList.remove('hidden');
                return;
            }

            // Ocultar resultados y errores previos
            resultsContainer.classList.add('hidden');
            distanceContainer.classList.add('hidden');
            errorBox.classList.add('hidden');
            matchAlert.classList.add('hidden'); // Siempre ocultar al inicio
            
            // Mostrar estado de carga y deshabilitar bot贸n
            message.classList.remove('hidden');
            btn.disabled = true;
            btn.textContent = 'Buscando...';

            // Opciones de Geolocation: alta precisi贸n y tiempo m谩ximo de espera de 10 segundos
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0 // No usar cach茅
            };

            // Llamada a la API de Geolocation
            navigator.geolocation.getCurrentPosition(success, error, options);
        }

        // Asignar el evento click al bot贸n
        btn.addEventListener('click', getLocation);

    </script>
</body>
</html>

